<html lang="en">
<head>
  <title>HubSpot Scoreboard</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">


  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js" integrity="sha256-yr4fRk/GU1ehYJPAs8P4JlTgu0Hdsp4ZKrx8bDEDC3I=" crossorigin="anonymous"></script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>




  <script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
        // Use a "/test" namespace.
        // An application can open a connection on multiple namespaces, and
        // Socket.IO will multiplex all those connections on a single
        // physical channel. If you don't care about multiple channels, you
        // can set the namespace to an empty string.
        namespace = '/index';

        // Connect to the Socket.IO server.
        // The connection URL has the following format, relative to the current page:
        //     http[s]://<domain>:<port>[/<namespace>]
        var socket = io(namespace);

        // Event handler for new connections.
        // The callback function is invoked when a connection with the
        // server is established.
        //socket.on('connect', function() {
        //    socket.emit('my_event', {data: 'I\'m connected!'});
        //});

        // Event handler for server sent data.
        // The callback function is invoked whenever the server emits data
        // to the client. The data is then displayed in the "Received"
        // section of the page.


        //
        // event handler for new_deal
        //
        socket.on('new_deal', function(msg, cb) {
            //
            // check if a profile pic exists, if not use '/static/no-pic.png'
            //
            pictureURL = '/static/img/uploads/' + msg.firstName + '.' + msg.lastName + '.png'; 
            var http = new XMLHttpRequest();
            http.open('HEAD', pictureURL, false);
            http.send();
            if (http.status!=200){
                pictureURL = '/static/no-pic.png';
            }

            //
            // setup and show rep who won deal
            //
            $('#dealInfo').html( '<strong>' + msg.firstName + ' ' + msg.lastName + ' just closed a deal "' + msg.Name + '" with a value of $' + msg.Value + '</strong>' );

            $('#repImage').html('<img  src="' + pictureURL + '" width="300" height="300" > </img> '   );

            $('#winSound').html('<audio controls id="audioPlay"> <source src="/static/money.mp3" type="audio/mpeg"> </audio> '   );

            $(".collapse").collapse('show')
            document.getElementById("audioPlay").play();

            //
            // leave on screen for 20 secs
            //
            setTimeout(function(){
                $(".collapse").collapse('hide');
            }, 20000);

 
        });

        socket.on('connect', function() {
            console.log("socket connected");
            socket.emit('mess 1', {data: 'Client connected!'});
        });


        //
        // Event Handler for Total Spend Table
        //
        socket.on('totalDollar', function(msg, cb) {
            var trHTML = '';
            console.log("totalDollar received");
            $.each(msg, function(i, item) {
                if (i != 'NoOfRows' ) {
                     trHTML += '<tr><td>' + item.firstName + ' ' + item.lastName + '</td><td>$' + item.totalDollar + '</td></tr>';
                }
            });
            $('#totalDollar').html(trHTML);

        });

        //
        // Event Handler for Total Count Table
        //
        socket.on('totalCount', function(msg, cb) {
            var trHTML = '';
            $.each(msg, function(i, item) {
                if (i != 'NoOfRows' ) {
                     trHTML += '<tr><td>' + item.firstName + ' ' + item.lastName + '</td><td>' + item.totalDeals + '</td></tr>';
                }
            });
            $('#totalCount').html(trHTML);

        });



    });
</script>

</head>
<body> 
    <div class="jumbotron jumbotron-fluid text-center bg-primary text-white  ">
        <h1>HubSpot Deal Scoreboard</h1>
        <p>This weeks leaderboard</p>
    </div>

    <div id='DealAlert'class="collapse"  >
        <div id="DealDetails" class="row"  >
            <div class="col-md-2"></div>
            <div class="col-md-8">
                <h3>
                    <div id="dealInfo" class="alert alert-danger text-center" ></div>
                </h3>
            </div>
            <div class="col-md-2"></div>
        </div>

        <div id="DealImage" class="row"  >
            <div class="col-md-5"></div>
            <div class="col-md-2">
                <div id="repImage"></div>
                <div id="winSound" class="d-none"></div>
            </div>

            <div class="col-md-5"></div>
        </div>
    </div>


 

    <div class="row">
        <div class="col-md-2"></div>

        <div class="col-md-3 ">
            <div class="well ">
                <table class="table table-striped table-bordered " >
                    <thead class = "bg-primary text-white"> 
                    <tr>
                        <th id="repName" >Name</th>
                        <th>Total $ Sales</th>
                    </tr>
                    </thead >
                    <tbody id="totalDollar">
                    </tbody>
                </table>    
            </div>        
        </div>

        <div class="col-md-2"></div>
        <div class="col-md-3">
            <div class="well ">
                <table class="table table-striped table-bordered">
                    <thead class = "bg-primary text-white"> 
                    <tr>
                        <th>Name</th>
                        <th>Total # of Sales</th>
                    </tr>
                    </thead>
                    <tbody id="totalCount">
                    </tbody>
                </table>   
            </div>         
        </div>

        <div class="col-md-2"></div>


    </div>



</body>
</html>